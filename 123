<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPPH 抗自由基試紙分析儀 (CIE LAB)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定主要字體為 Inter，並確保中文字體顯示 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f7f9fb;
        }
        /* 針對結果表格進行優化 */
        .result-table th, .result-table td {
            padding: 12px 16px;
            text-align: center;
        }
        .result-table thead th {
            background-color: #e5e7eb; /* 淺灰色背景 */
            font-weight: 600;
            border-bottom: 2px solid #d1d5db;
        }
        .result-table tbody tr:nth-child(odd) {
            background-color: #f3f4f6; /* 斑馬紋效果 */
        }
        .result-table tbody tr:hover {
            background-color: #e0f2fe; /* 淺藍色懸停效果 */
            cursor: default;
        }
        /* 隱藏原生數字輸入框的箭頭 */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">DPPH 試紙分析 (CIE LAB)</h1>
        <p class="text-sm text-gray-500 mb-6">請輸入各組的名稱、濃度 (樣品組) 及 CIE LAB (L, a*, b*) 定量值，然後點擊計算。</p>

        <!-- 1. 計算原理與公式說明 (提升到頂部，方便查核) -->
        <div id="formula-section" class="mb-6 p-4 bg-gray-100 rounded-lg border border-gray-300 shadow-inner">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">計算原理與公式 (供查核用)</h2>
            <p class="text-gray-700 mb-4 text-sm">本分析基於 CIE LAB 色空間，使用歐幾里得距離 ($\Delta E_{ab}^*$) 定量 DPPH 清除反應。所有 $\Delta E$ 均與 DPPH 紫色組 (0% 清除率) 的顏色點進行比較。</p>
            
            <ol class="list-decimal list-inside space-y-2 pl-4 text-xs text-gray-700">
                <li>
                    <p><strong>色差計算 ($\Delta E_{Sample}$):</strong> 樣品與 DPPH 紫色組的 $\Delta E_{ab}^*$。其中 ($L, a^*, b^*$) 分別代表亮度、紅/綠軸和黃/藍軸。</p>
                    <code class="block bg-white p-2 rounded-md shadow-sm overflow-x-auto text-blue-700">$$ \Delta E_{ab}^* = \sqrt{(L_{Sample} - L_{DPPH})^2 + (a^*_{Sample} - a^*_{DPPH})^2 + (b^*_{Sample} - b^*_{DPPH})^2} $$</code>
                </li>
                <li>
                    <p><strong>校正後色差 ($\Delta E_{Corrected}$):</strong> 使用空白試紙的 $\Delta E_{Blank}$ 進行校正，以消除背景影響。</p>
                    <code class="block bg-white p-2 rounded-md shadow-sm overflow-x-auto text-blue-700">$$ \Delta E_{Corrected} = \frac{\Delta E_{Sample}}{\Delta E_{Blank}} $$</code>
                </li>
                <li>
                    <p><strong>DPPH 清除率 (抑制率):</strong> 以維生素 C ($100\%$ 參考) 的校正後色差為滿分基準。</p>
                    <code class="block bg-white p-2 rounded-md shadow-sm overflow-x-auto text-blue-700">$$ \text{清除率} (\%) = \frac{\Delta E_{Corrected, Sample}}{\Delta E_{Corrected, \text{Vit C}}} \times 100\% $$</code>
                </li>
            </ol>
        </div>

        <!-- 2. 總輸入容器 -->
        <div class="space-y-6">
            <!-- 2.1. 空白與對照組區塊 (固定組) -->
            <div id="control-data-container" class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <h2 class="text-xl font-semibold text-indigo-800 mb-4">空白試紙與反應對照組 (固定組)</h2>
                
                <form id="control-form" class="space-y-4">
                    <!-- Control group inputs generated by JS -->
                </form>
            </div>

            <!-- 2.2. 樣品濃度組區塊 (動態組) -->
            <div id="sample-data-container" class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">樣品濃度組 (可增減)</h2>
                
                <div id="sample-inputs-area" class="space-y-4 mb-4">
                    <!-- Sample inputs generated by JS -->
                </div>

                <button id="add-sample-btn" class="w-full px-4 py-2 text-blue-600 border border-blue-300 rounded-lg hover:bg-blue-100 transition duration-150 ease-in-out font-medium">
                    + 新增樣品濃度組
                </button>
            </div>
        </div>

        <button id="calculate-btn" class="mt-6 w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-150 ease-in-out">
            計算 ΔE 與清除率 (%)
        </button>

        <!-- 3. 計算結果區塊 -->
        <div id="results-area" class="mt-8">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold text-gray-800">分析結果</h2>
                <button id="download-csv-btn" class="px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out">
                    下載 CSV 結果
                </button>
            </div>
            
            <div id="calculation-constants" class="mb-6 p-3 bg-green-50 rounded-md border border-green-200 text-green-800 text-sm">
                <!-- Calculated constants filled by JS -->
            </div>

            <table class="result-table w-full border-collapse rounded-lg overflow-hidden text-sm">
                <thead>
                    <tr>
                        <th class="w-1/4">組別 (濃度)</th>
                        <th class="w-1/4">ΔE 色差值 (與紫色組比較)</th>
                        <th class="w-1/4">校正 ΔE (ΔE / ΔE_Blank)</th>
                        <th class="w-1/4 font-bold text-blue-700">DPPH 清除率 (%)</th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Final results filled by JS -->
                </tbody>
            </table>
        </div>
        
        <!-- ISO 17025 備註 -->
        <div class="mt-8 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500 text-yellow-800 text-xs">
            <p class="font-bold">品質系統備註 (ISO/IEC 17025 考量):</p>
            <p>本分析採用 **ΔE 歐幾里得距離** 作為定量指標。使用「空白試紙組」計算的 ΔE 作為校正基準（除法校正），旨在減少環境光線或拍照條件對背景的干擾，符合校正和品質控制的要求。**ΔE 歐幾里得距離** 是一種簡化的色差公式 ($\Delta E_{ab}^*$)，在實務中更複雜的 CIEDE2000 公式可能會提供更精確的人眼感知差異。</p>
        </div>

    </div>

    <script>
        // ----------------------------------------------------
        // 1. 預設數據與核心計算函數
        // ----------------------------------------------------

        // Global variable to store the latest final calculated results for CSV download
        let latestFinalResults = [];

        // 預設原始數據 (用於初始化輸入框)
        const defaultRawData = {
            blanks: [
                { name: "空白試紙組 (前端)", key: "blank1", L: 49.8, a: -1.6, b: 3.2 },
                { name: "空白試紙組 (後端)", key: "blank2", L: 49.8, a: -1.6, b: 3.2 }
            ],
            dpphControl: { name: "DPPH 紫色組 (0% 清除率)", key: "dpph", L: 45.8, a: 2.3, b: 0.8 },
            vitCControl: { name: "維生素 C 對照組 (100% 參考)", key: "vitc", L: 37.6, a: 2.3, b: 5.4 },
            samples: [
                { name: "樣品 A", concentration: 0.005, key: "sample1", L: 44.3, a: 2.8, b: 2.3 },
                { name: "樣品 A", concentration: 0.01, key: "sample2", L: 41.8, a: 2.6, b: 4.1 },
                { name: "樣品 A", concentration: 0.02, key: "sample3", L: 40.0, a: 3.7, b: 3.9 },
                { name: "樣品 A", concentration: 0.05, key: "sample4", L: 38.5, a: 2.4, b: 6.7 },
                { name: "樣品 A", concentration: 0.1, key: "sample5", L: 37.8, a: 2.4, b: 6.4 }
            ]
        };
        
        // Counter for generating new sample keys
        let sampleKeyCounter = defaultRawData.samples.length + 1;

        /**
         * Calculates the color difference (Delta E*ab) in the CIE LAB space.
         * @param {Object} c1 - First color {L, a, b}.
         * @param {Object} c2 - Second color {L, a, b}.
         * @returns {number} Delta E value.
         */
        function calculateDeltaE(c1, c2) {
            const deltaL = c1.L - c2.L;
            const deltaA = c1.a - c2.a;
            const deltaB = c1.b - c2.b;
            // Formula 1: Delta E (Euclidean distance)
            return Math.sqrt(deltaL * deltaL + deltaA * deltaA + deltaB * deltaB);
        }

        // ----------------------------------------------------
        // 2. 數據處理與介面渲染
        // ----------------------------------------------------

        /**
         * Creates the HTML structure for a group including LAB inputs.
         * @param {Object} data - Group data.
         * @returns {string} HTML string.
         */
        function createInputGroup(data) {
            const isSample = data.key.startsWith('sample');
            const isControl = data.key.startsWith('dpph') || data.key.startsWith('vitc');
            // const isBlank = data.key.startsWith('blank');

            // Concentration input or placeholder
            let concentrationInput;
            if (isSample) {
                concentrationInput = `<input type="number" step="0.001" id="${data.key}_conc" placeholder="濃度 (mg/mL)" value="${data.concentration || 0}" 
                   class="w-1/3 px-2 py-1 border border-gray-300 rounded-md text-sm text-center focus:ring-purple-500 focus:border-purple-500" 
                   title="濃度 (mg/mL)">`;
            } else {
                let label = isControl ? (data.key === 'vitc' ? '100% 參考' : '0% 對照') : '背景空白';
                concentrationInput = `<div class="w-1/3 text-xs text-gray-500 flex items-center justify-center bg-gray-100 rounded-md py-1">${label}</div>`;
            }

            // Remove button (only for sample groups)
            const removeButton = isSample 
                ? `<button type="button" class="flex-shrink-0 text-red-400 hover:text-red-600 transition ml-2" onclick="removeSampleRow('${data.key}')" title="移除此樣品"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.5H2.75a.75.75 0 0 0 0 1.5h14.5a.75.75 0 0 0 0-1.5H14v-.5A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 12.5a.75.75 0 0 1-.75-.75v-3.5a.75.75 0 0 1 1.5 0v3.5a.75.75 0 0 1-.75.75Zm.75 4a.75.75 0 0 0 0-1.5h-1.5a.75.75 0 0 0 0 1.5h1.5Z" clip-rule="evenodd" /><path d="M4.125 5.75c-.322 0-.623.12-.85.347A1.25 1.25 0 0 0 2.5 6.999v7.75c0 .69.56 1.25 1.25 1.25h12.5a1.25 1.25 0 0 0 1.25-1.25V6.999a1.25 1.25 0 0 0-.347-.85c-.227-.227-.528-.347-.85-.347H4.125Z" /></svg></button>`
                : '';

            // Common class for LAB inputs
            const inputClass = "w-full text-center px-2 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm";
            
            return `
                <div class="input-group flex flex-col space-y-2 p-3 bg-white rounded-lg shadow-md border-l-4 ${isSample ? 'border-blue-400' : 'border-gray-300'}" id="group_${data.key}">
                    <!-- Top: Name & Concentration -->
                    <div class="flex space-x-2 items-center">
                        <input type="text" id="${data.key}_name" placeholder="組別名稱" value="${data.name}" 
                               class="w-full ${isSample ? 'sm:w-3/5' : 'sm:w-2/3'} px-2 py-1 border border-gray-300 rounded-md font-medium text-gray-700 text-sm focus:ring-indigo-500 focus:border-indigo-500" 
                               title="組別名稱">
                        ${concentrationInput}
                        ${removeButton}
                    </div>
                    <!-- Bottom: LAB values -->
                    <div class="flex space-x-2 pt-1 border-t border-gray-100">
                        <input type="number" step="0.1" id="${data.key}_L" placeholder="L" value="${data.L}" class="${inputClass}" title="L: 亮度">
                        <input type="number" step="0.1" id="${data.key}_a" placeholder="a*" value="${data.a}" class="${inputClass}" title="a*: 紅/綠軸">
                        <input type="number" step="0.1" id="${data.key}_b" placeholder="b*" value="${data.b}" class="${inputClass}" title="b*: 黃/藍軸">
                    </div>
                </div>
            `;
        }

        /**
         * Renders fixed control inputs.
         */
        function renderControlInputs() {
            const form = document.getElementById('control-form');
            let html = '';

            // 1. Blank control
            html += `<p class="font-bold text-gray-600 pt-2 pb-1">空白試紙組 (背景校正):</p>`;
            defaultRawData.blanks.forEach(d => {
                html += createInputGroup(d);
            });

            // 2. Reaction controls
            html += `<p class="font-bold text-gray-600 pt-4 pb-1">反應對照組:</p>`;
            html += createInputGroup(defaultRawData.dpphControl);
            html += createInputGroup(defaultRawData.vitCControl);

            form.innerHTML = html;
        }

        /**
         * Renders sample inputs (including dynamic ones).
         */
        function renderSampleInputs() {
            const area = document.getElementById('sample-inputs-area');
            area.innerHTML = '';
            
            // Render default samples on first load
            defaultRawData.samples.forEach(d => {
                area.insertAdjacentHTML('beforeend', createInputGroup(d));
            });
        }
        
        /**
         * Adds a new sample input row.
         */
        function addSampleRow(initialData = { name: `樣品 B`, concentration: 0.01, L: 45.0, a: 3.0, b: 3.0 }) {
            const newKey = `sample${sampleKeyCounter++}`;
            const newSampleData = { ...initialData, key: newKey, name: `${initialData.name} ${sampleKeyCounter - defaultRawData.samples.length - 1}` };
            
            const area = document.getElementById('sample-inputs-area');
            area.insertAdjacentHTML('beforeend', createInputGroup(newSampleData));
        }

        /**
         * Removes a sample input row.
         */
        window.removeSampleRow = function(key) {
            const element = document.getElementById(`group_${key}`);
            if (element) {
                element.remove();
                // Recalculate after removal
                analyzeDPPH();
            }
        }


        /**
         * Reads user data from input fields.
         * @returns {Object} Object containing all read data.
         */
        function getFormData() {
            const formData = { blanks: [], samples: [] };
            
            // Helper function to read a single input group
            const readInput = (key, isSample = false) => {
                const L = parseFloat(document.getElementById(`${key}_L`).value);
                const a = parseFloat(document.getElementById(`${key}_a`).value);
                const b = parseFloat(document.getElementById(`${key}_b`).value);
                const name = document.getElementById(`${key}_name`).value.trim();
                
                if (isNaN(L) || isNaN(a) || isNaN(b) || name === "") {
                    throw new Error(`組別 ${name} 的 LAB 值或名稱輸入無效，請檢查。`);
                }

                let concentration = undefined;
                if (isSample) {
                    const concElement = document.getElementById(`${key}_conc`);
                    concentration = parseFloat(concElement.value);
                    if (isNaN(concentration) || concentration < 0) {
                        throw new Error(`組別 ${name} 的濃度輸入無效，請檢查。`);
                    }
                }

                return { name, key, L, a, b, concentration };
            };

            // 1. Read fixed controls (blanks and standards)
            [...defaultRawData.blanks, defaultRawData.dpphControl, defaultRawData.vitCControl].forEach(d => {
                const data = readInput(d.key);
                if (d.key.startsWith('blank')) {
                    formData.blanks.push(data);
                } else if (d.key.startsWith('dpph')) {
                    formData.dpphControl = data;
                } else if (d.key.startsWith('vitc')) {
                    formData.vitCControl = data;
                }
            });

            // 2. Read dynamic sample groups
            document.querySelectorAll('#sample-inputs-area > .input-group').forEach(group => {
                const key = group.id.replace('group_', '');
                formData.samples.push(readInput(key, true));
            });
            
            if (formData.samples.length === 0) {
                 throw new Error("請至少輸入一組樣品數據。");
            }
            
            return formData;
        }


        /**
         * Executes the main DPPH analysis logic.
         */
        function analyzeDPPH() {
            let currentData;
            try {
                // 1. Get user input data
                currentData = getFormData();
            } catch (e) {
                // Display error message
                document.getElementById('calculation-constants').innerHTML = '';
                document.getElementById('results-table-body').innerHTML = '';
                document.getElementById('results-area').insertAdjacentHTML('beforeend', `<p class="text-red-600 font-bold p-4 bg-red-100 rounded-lg mt-4" id="error-message">數據錯誤: ${e.message}</p>`);
                latestFinalResults = []; // Clear results on error
                return;
            }
            // Clear old error messages
            const oldError = document.getElementById('error-message');
            if (oldError) oldError.remove();


            // A. Calculate average of blank papers
            const avgBlank = {
                L: currentData.blanks.reduce((sum, d) => sum + d.L, 0) / currentData.blanks.length,
                a: currentData.blanks.reduce((sum, d) => sum + d.a, 0) / currentData.blanks.length,
                b: currentData.blanks.reduce((sum, d) => sum + d.b, 0) / currentData.blanks.length
            };

            // B. Calculate correction baseline Delta E_Blank
            // This is the Delta E between average Blank and the DPPH purple control
            const deltaEBlank = calculateDeltaE(avgBlank, currentData.dpphControl);
            
            if (deltaEBlank <= 0.001) { // Check for near zero to prevent division by zero
                 document.getElementById('results-area').insertAdjacentHTML('beforeend', `<p class="text-red-600 font-bold p-4 bg-red-100 rounded-lg mt-4" id="error-message">計算錯誤: 校正基準 ΔE_Blank (空白試紙與 DPPH 紫色組的色差) 過小或為零 (${deltaEBlank.toFixed(5)})，無法進行除法校正。請檢查輸入數據。</p>`);
                 latestFinalResults = []; // Clear results on error
                 return;
            }

            // C. Calculate raw Delta E (ΔE_Sample) for all test groups
            const allTests = [
                { 
                    name: currentData.vitCControl.name, 
                    L: currentData.vitCControl.L, 
                    a: currentData.vitCControl.a, 
                    b: currentData.vitCControl.b, 
                    concentration: '100% (對照)',
                    isControl: true
                },
                ...currentData.samples.map(s => ({...s, isControl: false}))
            ];

            const results = allTests.map(test => {
                // 1. Raw ΔE (compared to DPPH purple control)
                const deltaE = calculateDeltaE(test, currentData.dpphControl);
                
                // 2. Corrected ΔE (Formula 2: Divided by ΔE_Blank)
                const correctedDeltaE = deltaE / deltaEBlank;
                
                return {
                    ...test,
                    deltaE: deltaE,
                    correctedDeltaE: correctedDeltaE
                };
            });
            
            // D. Get the corrected ΔE of the Vitamin C control (100% standard)
            const vitCCorrectedDeltaE = results.find(r => r.isControl).correctedDeltaE; // Find the Vitamin C result
            
            if (vitCCorrectedDeltaE <= 0.001) {
                 document.getElementById('results-area').insertAdjacentHTML('beforeend', `<p class="text-red-600 font-bold p-4 bg-red-100 rounded-lg mt-4" id="error-message">計算錯誤: 維生素 C 對照組的校正 ΔE 過小或為零 (${vitCCorrectedDeltaE.toFixed(5)})，無法計算清除率。請檢查維生素 C 組的輸入數據。</p>`);
                 latestFinalResults = []; // Clear results on error
                 return;
            }

            // E. Calculate DPPH Scavenging Rate (%)
            const finalResults = results.map(result => {
                let scavengingRate = 0;
                // Formula 3: Scavenging Rate (%) = (Sample Corrected ΔE / Vit C Corrected ΔE) * 100
                scavengingRate = (result.correctedDeltaE / vitCCorrectedDeltaE) * 100;
                
                return {
                    ...result,
                    scavengingRate: scavengingRate
                };
            });

            // Store results globally for CSV download
            latestFinalResults = finalResults;

            // Render results to DOM
            renderResults(avgBlank, deltaEBlank, vitCCorrectedDeltaE, finalResults);
        }

        /**
         * Renders analysis results to the table and constant block.
         */
        function renderResults(avgBlank, deltaEBlank, vitCCorrectedDeltaE, finalResults) {
            const resultsTableBody = document.getElementById('results-table-body');
            const calculationConstants = document.getElementById('calculation-constants');

            // Render calculation constants
            calculationConstants.innerHTML = `
                <p><strong>平均空白試紙組 (L, a*, b*):</strong> ${avgBlank.L.toFixed(2)}, ${avgBlank.a.toFixed(2)}, ${avgBlank.b.toFixed(2)}</p>
                <p><strong>校正基準 ΔE (ΔE_Blank):</strong> ${deltaEBlank.toFixed(3)}</p>
                <p><strong>維生素 C (100% 參考) 校正 ΔE (C_VitC):</strong> ${vitCCorrectedDeltaE.toFixed(3)}</p>
            `;

            // Render final results
            let resultsHtml = '';
            finalResults.forEach(r => {
                const concentrationDisplay = r.concentration !== '100% (對照)' && r.concentration !== undefined
                    ? ` (${r.concentration} mg/mL)` 
                    : r.concentration === '100% (對照)' ? ' (100% 參考)' : '';
                    
                const clearanceColor = r.scavengingRate >= 100 ? 'text-green-600' : 
                                       r.scavengingRate >= 50 ? 'text-blue-600' : 
                                       'text-yellow-600';

                resultsHtml += `
                    <tr>
                        <td class="font-medium whitespace-nowrap">${r.name}${concentrationDisplay}</td>
                        <td>${r.deltaE.toFixed(3)}</td>
                        <td>${r.correctedDeltaE.toFixed(3)}</td>
                        <td class="font-bold text-lg ${clearanceColor}">${r.scavengingRate.toFixed(2)} %</td>
                    </tr>
                `;
            });
            resultsTableBody.innerHTML = resultsHtml;
        }

        /**
         * Generates and downloads the analysis results as a CSV file.
         */
        function downloadCSV() {
            if (latestFinalResults.length === 0) {
                alert('沒有可供下載的分析結果。請先點擊「計算」按鈕。');
                return;
            }

            // Define CSV header
            const header = [
                "組別",
                "濃度 (mg/mL)",
                "原始 ΔE (vs DPPH)",
                "校正 ΔE (ΔE / ΔE_Blank)",
                "DPPH 清除率 (%)"
            ];
            
            // Map results to CSV rows
            const csvRows = latestFinalResults.map(r => {
                const concentration = r.concentration === '100% (對照)' ? '100% (參考)' : r.concentration;
                return [
                    r.name.replace(/,/g, ''), // Remove commas from name to avoid breaking CSV format
                    concentration,
                    r.deltaE.toFixed(3),
                    r.correctedDeltaE.toFixed(3),
                    r.scavengingRate.toFixed(2)
                ].join(',');
            });

            // Combine header and rows
            const csvContent = [
                header.join(','),
                ...csvRows
            ].join('\n');

            // Create a Blob and trigger download
            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' }); // Add BOM for Chinese encoding
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'DPPH_Assay_Results_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ----------------------------------------------------
        // 3. 初始化與事件監聽
        // ----------------------------------------------------

        window.onload = function() {
            // 1. Render control and sample inputs
            renderControlInputs();
            renderSampleInputs();

            // 2. Set button event listeners
            document.getElementById('calculate-btn').addEventListener('click', analyzeDPPH);
            document.getElementById('add-sample-btn').addEventListener('click', () => {
                // Add new sample with default values
                addSampleRow({ name: `樣品 A`, concentration: 0.01, L: 45.0, a: 3.0, b: 3.0 });
            });
            
            // Add listener for the new CSV download button
            document.getElementById('download-csv-btn').addEventListener('click', downloadCSV);
            
            // 3. Auto-run initial calculation on load
            analyzeDPPH();
        };

    </script>
</body>
</html>
